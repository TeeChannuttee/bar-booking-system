@model List<Booking>
@{
    ViewData["Title"] = "การจองของฉัน";
}

<div class="container py-4">
    <h2 class="mb-4"><i class="bi bi-list-check"></i> การจองของฉัน</h2>

    @if (Model.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> คุณยังไม่มีการจอง
            <a asp-action="Create" class="alert-link">จองโต๊ะเลย!</a>
        </div>
    }
    else
    {
        <div class="row">
            @foreach (var booking in Model)
            {
                var statusColor = booking.Status switch
                {
                    "Confirmed" => "success",
                    "Pending" => "warning",
                    "Cancelled" => "danger",
                    "Completed" => "secondary",
                    "CheckedIn" => "info",
                    "NoShow" => "dark",
                    _ => "primary"
                };

                var statusText = booking.Status switch
                {
                    "Confirmed" => "ยืนยันแล้ว",
                    "Pending" => "รอชำระเงิน",
                    "Cancelled" => "ยกเลิก",
                    "Completed" => "เสร็จสิ้น",
                    "CheckedIn" => "เช็คอินแล้ว",
                    "NoShow" => "ไม่มา",
                    _ => booking.Status
                };

                var isPast = booking.BookingDate.Add(booking.StartTime) < DateTime.Now;

                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-@statusColor text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="bi bi-receipt"></i> @booking.BookingCode
                                </span>
                                <span class="badge bg-white text-@statusColor">@statusText</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-shop"></i> @booking.Table.Branch.Name
                            </h5>

                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">วันที่</small>
                                    <p class="mb-1">@booking.BookingDate.ToString("dd/MM/yyyy")</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">เวลา</small>
                                    <p class="mb-1">@booking.StartTime.ToString(@"hh\:mm") - @booking.EndTime.ToString(@"hh\:mm")</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">โต๊ะ</small>
                                    <p class="mb-1">@booking.Table.TableNumber (@booking.Table.Zone)</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">จำนวน</small>
                                    <p class="mb-1">@booking.NumberOfGuests คน</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">ยอดรวม</small>
                                    <p class="mb-1 fw-bold">฿@booking.TotalAmount.ToString("N0")</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">มัดจำ</small>
                                    <p class="mb-1">฿@booking.DepositAmount.ToString("N0")</p>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <a asp-action="Details" asp-route-id="@booking.Id"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> รายละเอียด
                                </a>

                                @if (booking.Status == "Confirmed" && !isPast)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-info"
                                            onclick="showQRCode('@booking.BookingCode')">
                                        <i class="bi bi-qr-code"></i> QR Code
                                    </button>

                                    @if ((booking.BookingDate.Add(booking.StartTime) - DateTime.Now).TotalHours >= 24)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-warning"
                                                onclick="cancelBooking(@booking.Id)">
                                            <i class="bi bi-x-circle"></i> ยกเลิก
                                        </button>
                                    }
                                }

                                @if (booking.Status == "Pending")
                                {
                                    <a asp-controller="Payment" asp-action="ProcessPayment"
                                       asp-route-bookingId="@booking.Id"
                                       class="btn btn-sm btn-warning">
                                        <i class="bi bi-credit-card"></i> ชำระเงิน
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        function cancelBooking(bookingId) {
            Swal.fire({
                title: 'ยืนยันการยกเลิก?',
                html: 'คุณจะได้รับเงินคืน <strong>70%</strong> ของยอดมัดจำ<br>ภายใน 7-14 วันทำการ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ยืนยัน ยกเลิกการจอง',
                cancelButtonText: 'ไม่ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Create form and submit
                    var form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/Booking/Cancel/' + bookingId;

                    var token = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (token) {
                        form.appendChild(token.cloneNode());
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        function showQRCode(bookingCode) {
            Swal.fire({
                title: 'QR Code สำหรับ Check-in',
                html: '<div id="qrcode" style="display: flex; justify-content: center; padding: 20px;"></div>',
                width: 400,
                didOpen: () => {
                    new QRCode(document.getElementById("qrcode"), {
                        text: bookingCode,
                        width: 200,
                        height: 200
                    });
                }
            });
        }
    </script>
}
